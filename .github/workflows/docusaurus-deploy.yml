name: Build and Deploy Docusaurus Documentation

on:
  # Only run manually when requested
  workflow_dispatch:
    inputs:
      deploy_message:
        description: 'Message for the deployment PR'
        required: true
        default: 'Update documentation'

jobs:
  build_and_deploy_docs:
    name: Build and Deploy Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: |
          npm install -g fs-extra

      - name: Create Docusaurus site
        run: |
          # Create a temporary directory for the documentation site
          mkdir -p kai-docs-temp
          cd kai-docs-temp

          # Create basic directories needed for the build
          mkdir -p docs src/css static/img

          # Create a package.json file without workspace references
          echo '{
            "name": "kai-documentation",
            "version": "1.0.0",
            "private": true,
            "scripts": {
              "docusaurus": "docusaurus",
              "start": "docusaurus start",
              "build": "docusaurus build",
              "swizzle": "docusaurus swizzle",
              "deploy": "docusaurus deploy",
              "clear": "docusaurus clear",
              "serve": "docusaurus serve",
              "write-translations": "docusaurus write-translations",
              "write-heading-ids": "docusaurus write-heading-ids"
            },
            "dependencies": {
              "@docusaurus/core": "3.7.0",
              "@docusaurus/preset-classic": "3.7.0",
              "@mdx-js/react": "3.0.0",
              "clsx": "2.1.0",
              "prism-react-renderer": "2.3.1",
              "react": "18.2.0",
              "react-dom": "18.2.0"
            },
            "devDependencies": {
              "@docusaurus/module-type-aliases": "3.7.0",
              "@docusaurus/types": "3.7.0",
              "typescript": "5.3.3"
            },
            "browserslist": {
              "production": [
                ">0.5%",
                "not dead",
                "not op_mini all"
              ],
              "development": [
                "last 1 chrome version",
                "last 1 firefox version",
                "last 1 safari version"
              ]
            },
            "engines": {
              "node": ">=18.0"
            }
          }' > package.json

          # Create a basic tsconfig.json file
          echo '{
            "compilerOptions": {
              "target": "es2020",
              "lib": ["dom", "dom.iterable", "esnext"],
              "allowJs": true,
              "skipLibCheck": true,
              "esModuleInterop": true,
              "allowSyntheticDefaultImports": true,
              "strict": true,
              "forceConsistentCasingInFileNames": true,
              "noFallthroughCasesInSwitch": true,
              "module": "esnext",
              "moduleResolution": "node",
              "resolveJsonModule": true,
              "isolatedModules": true,
              "jsx": "react-jsx"
            },
            "include": ["src", "docs"]
          }' > tsconfig.json

          # Create custom CSS
          echo '/**
           * Any CSS included here will be global. The classic template
           * bundles Infima by default. Infima is a CSS framework designed to
           * work well for content-centric websites.
           */

          /* You can override the default Infima variables here. */
          :root {
            --ifm-color-primary: #2e8555;
            --ifm-color-primary-dark: #29784c;
            --ifm-color-primary-darker: #277148;
            --ifm-color-primary-darkest: #205d3b;
            --ifm-color-primary-light: #33925d;
            --ifm-color-primary-lighter: #359962;
            --ifm-color-primary-lightest: #3cad6e;
            --ifm-code-font-size: 95%;
            --docusaurus-highlighted-code-line-bg: rgba(0, 0, 0, 0.1);
          }

          /* For readability concerns, you should choose a lighter palette in dark mode. */
          [data-theme="dark"] {
            --ifm-color-primary: #25c2a0;
            --ifm-color-primary-dark: #21af90;
            --ifm-color-primary-darker: #1fa588;
            --ifm-color-primary-darkest: #1a8870;
            --ifm-color-primary-light: #29d5b0;
            --ifm-color-primary-lighter: #32d8b4;
            --ifm-color-primary-lightest: #4fddbf;
            --docusaurus-highlighted-code-line-bg: rgba(0, 0, 0, 0.3);
          }' > src/css/custom.css

          # Create placeholder logo
          echo '<svg width="200" height="200" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
            <rect width="200" height="200" fill="#2e8555" />
            <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="72" fill="white">KAI</text>
          </svg>' > static/img/logo.svg

          # Create sidebars.js file - simplified version without TypeScript annotations
          echo '// Simple sidebars config without TypeScript annotations' > sidebars.js
          echo 'const sidebars = {' >> sidebars.js
          echo '  docs: [' >> sidebars.js
          echo '    {' >> sidebars.js
          echo '      type: "category",' >> sidebars.js
          echo '      label: "Introduction",' >> sidebars.js
          echo '      items: ["introduction"],' >> sidebars.js
          echo '    },' >> sidebars.js
          echo '    {' >> sidebars.js
          echo '      type: "category",' >> sidebars.js
          echo '      label: "Getting Started",' >> sidebars.js
          echo '      items: ["installation", "configuration"],' >> sidebars.js
          echo '    },' >> sidebars.js
          echo '    {' >> sidebars.js
          echo '      type: "category",' >> sidebars.js
          echo '      label: "Features",' >> sidebars.js
          echo '      items: ["features-overview"],' >> sidebars.js
          echo '    },' >> sidebars.js
          echo '    {' >> sidebars.js
          echo '      type: "category",' >> sidebars.js
          echo '      label: "Prompts",' >> sidebars.js
          echo '      items: [' >> sidebars.js
          echo '        "prompt-library",' >> sidebars.js
          echo '        "prompt-abtesting-segmentation",' >> sidebars.js
          echo '        "prompt-advanced-features",' >> sidebars.js
          echo '        "prompt-management",' >> sidebars.js
          echo '        "prompt-success-tracking",' >> sidebars.js
          echo '      ],' >> sidebars.js
          echo '    },' >> sidebars.js
          echo '    {' >> sidebars.js
          echo '      type: "category",' >> sidebars.js
          echo '      label: "Deployment",' >> sidebars.js
          echo '      items: ["deployment-guide", "kubernetes-architecture", "cicd-pipeline"],' >> sidebars.js
          echo '    },' >> sidebars.js
          echo '    {' >> sidebars.js
          echo '      type: "category",' >> sidebars.js
          echo '      label: "Other",' >> sidebars.js
          echo '      items: ["admin-panel", "queue-system", "notification-webhook-system"],' >> sidebars.js
          echo '    },' >> sidebars.js
          echo '  ],' >> sidebars.js
          echo '};' >> sidebars.js
          echo '' >> sidebars.js
          echo 'module.exports = sidebars;' >> sidebars.js

          # Create Docusaurus config file - simplified version without TypeScript annotations
          echo '// Simple config without TypeScript annotations' > docusaurus.config.js
          echo 'const config = {' >> docusaurus.config.js
          echo '  title: "KAI Documentation",' >> docusaurus.config.js
          echo '  tagline: "Comprehensive documentation for the KAI project",' >> docusaurus.config.js
          echo '  favicon: "img/favicon.ico",' >> docusaurus.config.js
          echo '  url: "https://basilakis.github.io",' >> docusaurus.config.js
          echo '  baseUrl: "/",' >> docusaurus.config.js
          echo '  organizationName: "Basilakis",' >> docusaurus.config.js
          echo '  projectName: "basilakis.github.io",' >> docusaurus.config.js
          echo '  trailingSlash: false,' >> docusaurus.config.js
          echo '  onBrokenLinks: "warn",' >> docusaurus.config.js
          echo '  onBrokenMarkdownLinks: "warn",' >> docusaurus.config.js
          echo '  i18n: {' >> docusaurus.config.js
          echo '    defaultLocale: "en",' >> docusaurus.config.js
          echo '    locales: ["en"],' >> docusaurus.config.js
          echo '  },' >> docusaurus.config.js
          echo '  presets: [' >> docusaurus.config.js
          echo '    [' >> docusaurus.config.js
          echo '      "classic",' >> docusaurus.config.js
          echo '      {' >> docusaurus.config.js
          echo '        docs: {' >> docusaurus.config.js
          echo '          sidebarPath: "./sidebars.js",' >> docusaurus.config.js
          echo '          routeBasePath: "/",' >> docusaurus.config.js
          echo '        },' >> docusaurus.config.js
          echo '        blog: false,' >> docusaurus.config.js
          echo '        theme: {' >> docusaurus.config.js
          echo '          customCss: "./src/css/custom.css",' >> docusaurus.config.js
          echo '        },' >> docusaurus.config.js
          echo '      },' >> docusaurus.config.js
          echo '    ],' >> docusaurus.config.js
          echo '  ],' >> docusaurus.config.js
          echo '  themeConfig: {' >> docusaurus.config.js
          echo '    navbar: {' >> docusaurus.config.js
          echo '      title: "KAI Documentation",' >> docusaurus.config.js
          echo '      logo: {' >> docusaurus.config.js
          echo '        alt: "KAI Logo",' >> docusaurus.config.js
          echo '        src: "img/logo.svg",' >> docusaurus.config.js
          echo '      },' >> docusaurus.config.js
          echo '      items: [' >> docusaurus.config.js
          echo '        {' >> docusaurus.config.js
          echo '          href: "https://github.com/Basilakis/kai",' >> docusaurus.config.js
          echo '          label: "GitHub",' >> docusaurus.config.js
          echo '          position: "right",' >> docusaurus.config.js
          echo '        },' >> docusaurus.config.js
          echo '      ],' >> docusaurus.config.js
          echo '    },' >> docusaurus.config.js
          echo '    footer: {' >> docusaurus.config.js
          echo '      style: "dark",' >> docusaurus.config.js
          echo '      links: [' >> docusaurus.config.js
          echo '        {' >> docusaurus.config.js
          echo '          title: "More",' >> docusaurus.config.js
          echo '          items: [' >> docusaurus.config.js
          echo '            {' >> docusaurus.config.js
          echo '              label: "GitHub",' >> docusaurus.config.js
          echo '              href: "https://github.com/Basilakis/kai",' >> docusaurus.config.js
          echo '            },' >> docusaurus.config.js
          echo '          ],' >> docusaurus.config.js
          echo '        },' >> docusaurus.config.js
          echo '      ],' >> docusaurus.config.js
          echo '      copyright: `Copyright © ${new Date().getFullYear()} KAI Project. Last updated: ${new Date().toISOString().split("T")[0]}. Built with Docusaurus.`,' >> docusaurus.config.js
          echo '    },' >> docusaurus.config.js
          echo '  },' >> docusaurus.config.js
          echo '};' >> docusaurus.config.js
          echo '' >> docusaurus.config.js
          echo 'module.exports = config;' >> docusaurus.config.js

          cd ..

      - name: Create placeholder files
        run: |
          # Create placeholder files for the sidebar
          mkdir -p kai-docs-temp/docs

          # Create introduction.md
          echo '---' > kai-docs-temp/docs/introduction.md
          echo 'id: introduction' >> kai-docs-temp/docs/introduction.md
          echo 'title: "Introduction to KAI"' >> kai-docs-temp/docs/introduction.md
          echo 'sidebar_label: "Introduction"' >> kai-docs-temp/docs/introduction.md
          echo 'slug: /' >> kai-docs-temp/docs/introduction.md
          echo '---' >> kai-docs-temp/docs/introduction.md
          echo '' >> kai-docs-temp/docs/introduction.md
          echo '# Introduction to KAI' >> kai-docs-temp/docs/introduction.md
          echo '' >> kai-docs-temp/docs/introduction.md
          echo 'Welcome to the KAI documentation. This documentation provides comprehensive information about the KAI platform, its features, and how to use it.' >> kai-docs-temp/docs/introduction.md

          # Create installation.md
          echo '---' > kai-docs-temp/docs/installation.md
          echo 'id: installation' >> kai-docs-temp/docs/installation.md
          echo 'title: "Installation"' >> kai-docs-temp/docs/installation.md
          echo 'sidebar_label: "Installation"' >> kai-docs-temp/docs/installation.md
          echo '---' >> kai-docs-temp/docs/installation.md
          echo '' >> kai-docs-temp/docs/installation.md
          echo '# Installation' >> kai-docs-temp/docs/installation.md
          echo '' >> kai-docs-temp/docs/installation.md
          echo 'This page provides instructions for installing the KAI platform.' >> kai-docs-temp/docs/installation.md

          # Create configuration.md
          echo '---' > kai-docs-temp/docs/configuration.md
          echo 'id: configuration' >> kai-docs-temp/docs/configuration.md
          echo 'title: "Configuration"' >> kai-docs-temp/docs/configuration.md
          echo 'sidebar_label: "Configuration"' >> kai-docs-temp/docs/configuration.md
          echo '---' >> kai-docs-temp/docs/configuration.md
          echo '' >> kai-docs-temp/docs/configuration.md
          echo '# Configuration' >> kai-docs-temp/docs/configuration.md
          echo '' >> kai-docs-temp/docs/configuration.md
          echo 'This page provides instructions for configuring the KAI platform.' >> kai-docs-temp/docs/configuration.md

          # Create features-overview.md
          echo '---' > kai-docs-temp/docs/features-overview.md
          echo 'id: features-overview' >> kai-docs-temp/docs/features-overview.md
          echo 'title: "Features Overview"' >> kai-docs-temp/docs/features-overview.md
          echo 'sidebar_label: "Features Overview"' >> kai-docs-temp/docs/features-overview.md
          echo '---' >> kai-docs-temp/docs/features-overview.md
          echo '' >> kai-docs-temp/docs/features-overview.md
          echo '# Features Overview' >> kai-docs-temp/docs/features-overview.md
          echo '' >> kai-docs-temp/docs/features-overview.md
          echo 'This page provides an overview of the features available in the KAI platform.' >> kai-docs-temp/docs/features-overview.md

      - name: Process readme files
        run: |
          mkdir -p kai-docs-temp/docs
          cd readme
          # Add debug output to see what's happening
          echo "Current directory: $(pwd)"
          echo "Contents of current directory:"
          ls -la
          echo "Running process-readme-files.js..."
          node process-readme-files.js
          echo "Process complete. Contents of kai-docs-temp/docs:"
          ls -la ../kai-docs-temp/docs

          # Create basic directory structure
          mkdir -p ../kai-docs-temp/static/img

          # Note: prompt-library.md is now created by the process-readme-files.js script


          # Additional fix for any problematic files
          cd ../kai-docs-temp/docs

          # Fix the specific problematic files directly
          if [ -f "ai-ml/rag-system.md" ]; then
            echo "Fixing ai-ml/rag-system.md..."

            # Use sed to directly fix the front matter
            sed -i '1,6s/title: RAG System: Architecture/title: "RAG System: Architecture/g' ai-ml/rag-system.md
            sed -i '1,6s/sidebar_label: RAG System: Architecture/sidebar_label: "RAG System: Architecture/g' ai-ml/rag-system.md
            sed -i '1,6s/Guide$/Guide"/g' ai-ml/rag-system.md

            # Fix the syntax error around line 1039 (unexpected character)
            # Use a simple sed command to remove the problematic line
            sed -i '1039d' ai-ml/rag-system.md

            # Show the result
            echo "Fixed front matter:"
            cat ai-ml/rag-system.md | head -5
          fi

          # Fix all files with a simpler approach
          echo "Fixing all markdown files with potential YAML issues..."

          # Add quotes around any title or sidebar_label containing a colon
          find . -name "*.md" -exec sed -i '1,6s/^title: \([^"]*\):\([^"]*\)$/title: "\1:\2"/g' {} \;
          find . -name "*.md" -exec sed -i '1,6s/^sidebar_label: \([^"]*\):\([^"]*\)$/sidebar_label: "\1:\2"/g' {} \;

          # Remove all image references and fix specific issues
          echo "Removing all image references and fixing specific issues..."

          # Remove any line containing an image reference
          find . -name "*.md" -exec sed -i '/!\[.*\](.*)/d' {} \;

          # Also remove any HTML img tags
          find . -name "*.md" -exec sed -i '/<img.*>/d' {} \;

          # Fix the specific issue with prompt-management.md (material_type not defined)
          if [ -f "other/prompt-management.md" ]; then
            echo "Fixing other/prompt-management.md..."
            # Remove any JavaScript code or references to material_type
            sed -i 's/material_type/\"material_type\"/g' other/prompt-management.md
            sed -i 's/{material_type}/material_type/g' other/prompt-management.md
            # As a fallback, also remove any JSX/JavaScript code blocks
            sed -i '/{:.*/d' other/prompt-management.md
            sed -i '/```jsx/,/```/d' other/prompt-management.md
            sed -i '/```javascript/,/```/d' other/prompt-management.md
          fi

          # Fix any other problematic files with simple sed commands
          echo "Fixing any other problematic files..."

          # Remove any lines with problematic angle bracket patterns
          find . -name "*.md" -exec sed -i 's/<[0-9]\+:[0-9]\+>/REMOVED_PROBLEMATIC_TAG/g' {} \;

          # Fix common JavaScript/JSX issues in all markdown files
          echo "Fixing common JavaScript/JSX issues in all markdown files..."

          # Remove any JSX/JavaScript code blocks that might cause issues
          find . -name "*.md" -exec sed -i '/```jsx/,/```/d' {} \;
          find . -name "*.md" -exec sed -i '/```javascript/,/```/d' {} \;
          find . -name "*.md" -exec sed -i '/```js/,/```/d' {} \;

          # Remove any curly braces that might be interpreted as JSX expressions
          find . -name "*.md" -exec sed -i 's/{[^}]*}//g' {} \;

          # Remove any HTML-like tags that might be interpreted as JSX components
          find . -name "*.md" -exec sed -i 's/<[A-Z][^>]*>.*<\/[A-Z][^>]*>//g' {} \;

          # Note: We're only removing image references, not the files themselves

          # List all fixed files
          echo "Files with titles containing colons:"
          grep -l "title: \".*:.*\"" $(find . -name "*.md") || echo "None found"

      - name: Install Docusaurus dependencies
        run: |
          cd kai-docs-temp
          npm install --no-save @docusaurus/core@3.7.0 @docusaurus/preset-classic@3.7.0 @mdx-js/react@3.0.0 clsx@2.1.0 prism-react-renderer@2.3.1 react@18.2.0 react-dom@18.2.0 typescript@5.3.3

      - name: Build Docusaurus site
        run: |
          cd kai-docs-temp
          echo "Building Docusaurus site..."
          npx docusaurus build

          echo "Build complete. Contents of build directory:"
          ls -la build || echo "Build directory does not exist!"

      - name: Archive build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docusaurus-build
          path: kai-docs-temp/build/
          retention-days: 7

      - name: Install GitHub CLI
        run: |
          echo "Installing GitHub CLI..."
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: Basilakis/basilakis.github.io
          token: ${{ secrets.DOCS_DEPLOY_TOKEN }}
          path: target-repo

      - name: Create Pull Request
        run: |
          # Generate a unique branch name
          BRANCH_NAME="docs-update-$(date +%Y%m%d%H%M%S)"
          echo "Branch name: $BRANCH_NAME"

          # Create a new branch for the changes
          cd target-repo
          git checkout -b $BRANCH_NAME

          # Copy the built files
          echo "Removing existing files..."
          rm -rf * || true

          echo "Copying built files..."
          cp -r ../kai-docs-temp/build/* .

          echo "Contents after copying:"
          ls -la

          # Commit the changes
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          echo "Adding files to git..."
          git add .

          echo "Committing changes..."
          git commit -m "Deploy Documentation: ${{ github.event.inputs.deploy_message }}"

          echo "Pushing branch..."
          git push origin $BRANCH_NAME

          echo "Creating pull request..."
          # Create a pull request using GitHub CLI
          gh auth login --with-token <<< "${{ secrets.DOCS_DEPLOY_TOKEN }}"

          # Set PR body as a variable
          PR_BODY="This PR was automatically created by the GitHub Actions workflow to update the documentation site. It includes updated documentation from the latest changes in the kai repository, triggered by a manual workflow run."

          gh pr create \
            --title "Deploy Documentation: ${{ github.event.inputs.deploy_message }}" \
            --body "$PR_BODY" \
            --repo Basilakis/basilakis.github.io \
            --head $BRANCH_NAME \
            --base gh-pages
